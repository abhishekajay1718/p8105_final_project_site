---
title: "Subset analysis"
author: ""
date: "December 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(magick)
library(broom)

knitr::opts_chunk$set(echo = TRUE)

theme_set(theme_bw())
```

```{r finaldata, include = FALSE}
load('data/subset_dat.RData') 

subset <- dat_subset %>% 
  #Only retain variables of interest
  select(response_time, neighborhood, season:street_closed) %>% 
  #recode neightborhood (washington as opposed to Inwood + washington heights)
  mutate(neighborhood = ifelse(neighborhood == 'Inwood and Washington Heights',
      'Washington Heights', neighborhood)) %>% 
  mutate(prcp_ctg = fct_relevel(prcp_ctg, "no_prcp"),
         snow_ctg = fct_relevel(snow_ctg, "no_snow"),
         season = fct_relevel(season, "Spring"),
         hour_of_day = fct_relevel(hour_of_day, "night"))
```

## Logistic regression with among UWS
```{r}
uws_dat <- subset %>% filter(neighborhood == 'Upper West Side')
fit_logistic_uws =
  glm(over_8min ~ season + hour_of_day + snow_ctg + prcp_ctg + street_closed, 
      family = binomial(), data = uws_dat)

summary(fit_logistic_uws)
```

## Logistic regression with among Washington heights
```{r}
wash_dat <- subset %>% filter(neighborhood == 'Washington Heights')

fit_logistic_wash =
  glm(over_8min ~ season + hour_of_day + snow_ctg + prcp_ctg + street_closed, 
      family = binomial(), data = wash_dat)

summary(fit_logistic_wash)
```


```{r}
#Prepare table for visualization
 fit_logistic_uws %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  bind_cols(.,  exp(confint_tidy(fit_logistic_uws))) %>% 
  select(term, OR, conf.low, conf.high) %>% 
  filter(term == 'victim_racenon-white')
}
```




fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         lower_CI_OR = exp(estimate - 1.96*std.error),
         upper_CI_OR = exp(estimate + 1.96*std.error)) %>% 
  select(term, OR, lower_CI_OR, upper_CI_OR) %>% 
  mutate(term = c("intercept", "Fall", "Summer", "Winter", "Afternoon", "Dawn", "Morning", "snow 50+", "snow 50-", "prcp 25+", "prcp 25-")) %>%   knitr::kable(digits = 3, "html") %>% kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))


OR_total_df = 
fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         lower_CI_OR = exp(estimate - 1.96*std.error),
         upper_CI_OR = exp(estimate + 1.96*std.error)) %>% 
  select(term, OR, lower_CI_OR, upper_CI_OR) %>%
  as.tibble() %>% 
  mutate(ctg = c("intercept", 
                 "Season", "Season", "Season", 
                 "Hour of the day", "Hour of the day", "Hour of the day",
                 "Snow", "Snow",
                 "Rain", "Rain"),
         sub_ctg_chr = c("intercept",
                     "Fall", "Summer", "Winter",
                     "Afternoon", "Dawn", "Morning",
                     "50(mm)+", "0-50(mm)",
                     "25(mm)+", "0-25(mm)"),
         sub_ctg = c("1", "2", "1", "3", "8", "6", "7", "5", "4", "5", "4")) %>%   
  filter(ctg != "intercept")  

adj = .2 # This is used in position_nudge to move the dots

OR =
ggplot(OR_total_df, aes(x = OR, y = ctg, color = sub_ctg, 
                        label = sub_ctg_chr)) +
  geom_vline(aes(xintercept = 1), size = 1, linetype = "dashed") +
  geom_vline(aes(xintercept = 1.5), size = .6, linetype = "dashed") +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "1"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50", 
                 position = position_nudge(y = adj)) +
  geom_text(data = filter(OR_total_df, sub_ctg == "1"),
            aes(label = sub_ctg_chr), size = 6, colour = "seagreen4", 
            nudge_x = -.1, nudge_y = +.2, check_overlap = TRUE) +
  geom_point(data = filter(OR_total_df, sub_ctg == "1"), 
             size = 6, color = "seagreen4",
             position = position_nudge(y = adj)) +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "2"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50") +
  geom_text(data = filter(OR_total_df, sub_ctg == "2"),
            aes(label = sub_ctg_chr), size = 6, colour = "indianred4", 
            nudge_x = -.1, nudge_y = 0, check_overlap = TRUE) +
  geom_point(data = filter(OR_total_df, sub_ctg == "2"), 
             size = 6, color = "indianred4") +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "3"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50", position = position_nudge(y = -adj)) +
  geom_text(data = filter(OR_total_df, sub_ctg == "3"),
            aes(label = sub_ctg_chr), size = 6, colour = "lavenderblush4", 
            nudge_x = -.1, nudge_y = -.2, check_overlap = TRUE) +  
  geom_point(data = filter(OR_total_df, sub_ctg == "3"), 
             size = 6, color = "lavenderblush4",
             position = position_nudge(y = -adj)) +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "4"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50", position = position_nudge(y = +.1)) +
  geom_text(data = filter(OR_total_df, sub_ctg == "4"),
            aes(label = sub_ctg_chr), size = 6, colour = "skyblue2", 
            nudge_x = -.15, nudge_y = +.1, check_overlap = TRUE) +
  geom_point(data = filter(OR_total_df, sub_ctg == "4"), 
             size = 6, color = "skyblue2",
             position = position_nudge(y = +.1)) +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "5"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50", position = position_nudge(y = -.1)) +
  geom_text(data = filter(OR_total_df, sub_ctg == "5"),
            aes(label = sub_ctg_chr), size = 6, colour = "skyblue4", 
            nudge_x = -.16, nudge_y = -.1) +
  geom_point(data = filter(OR_total_df, sub_ctg == "5"), 
             size = 6, color = "skyblue4", 
             position = position_nudge(y = -.1)) +
 geom_errorbarh(data = filter(OR_total_df, sub_ctg == "6"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50", 
                 position = position_nudge(y = adj)) +
  geom_text(data = filter(OR_total_df, sub_ctg == "6"),
            aes(label = sub_ctg_chr), size = 6, colour = "seagreen4", 
            nudge_x = -.14, nudge_y = +.2, check_overlap = TRUE) +
  geom_point(data = filter(OR_total_df, sub_ctg == "6"), 
             size = 6, color = "seagreen4",
             position = position_nudge(y = adj)) +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "7"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50") +
  geom_text(data = filter(OR_total_df, sub_ctg == "7"),
            aes(label = sub_ctg_chr), size = 6, colour = "indianred4", 
            nudge_x = -.13, nudge_y = 0, check_overlap = TRUE) +
  geom_point(data = filter(OR_total_df, sub_ctg == "7"), 
             size = 6, color = "indianred4") +
  geom_errorbarh(data = filter(OR_total_df, sub_ctg == "8"), 
                 aes(xmax = upper_CI_OR, xmin = lower_CI_OR), 
                 size = .5, height = .1, 
                 color = "gray50", position = position_nudge(y = -adj)) +
  geom_text(data = filter(OR_total_df, sub_ctg == "8"),
            aes(label = sub_ctg_chr), size = 6, colour = "lavenderblush4", 
            nudge_x = -.13, nudge_y = -.2, check_overlap = TRUE) +  
  geom_point(data = filter(OR_total_df, sub_ctg == "8"), 
             size = 6, color = "lavenderblush4",
             position = position_nudge(y = -adj)) +
  scale_x_continuous(breaks = c(1, 1.5),
                     limits = c(.7, 1.8)) +
  labs(x = "Odds Ratio",
       y = " ") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 20),
        legend.position = "None") 

ggsave("OR.png", plot = OR, width = 45, height = 25, units = "cm")
```




<!-- ## CombinedC -->
```{r}
# fit_logistic =
#   glm(over_8min ~ season + hour_of_day + snow_ctg + prcp_ctg + street_closed + neighborhood, 
#       family = binomial(), data = subset)
# 
# summary(fit_logistic)
# neightborhood effect is not sig

```

